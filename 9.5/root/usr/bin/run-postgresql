#!/bin/bash

export ENABLE_REPLICATION=${ENABLE_REPLICATION:-false}

set -eu
export_vars=$(cgroup-limits) ; export $export_vars

source "${CONTAINER_SCRIPTS_PATH}/common.sh"

set_pgdata
check_env_vars
generate_passwd_file
generate_postgresql_config

if [ ! -f "$PGDATA/postgresql.conf" ]; then
  initialize_database
  NEED_TO_CREATE_USERS=yes
fi

pg_ctl -w start -o "-h ''"
if [ "${NEED_TO_CREATE_USERS:-}" == "yes" ]; then
  create_users

fi

set_passwords
set_connection_string



echo "$PSQL"
if [ "${NEED_TO_CREATE_POSTGIS:-}" == "yes" ]; then
	

	if [ "$( psql -tAc "SELECT 1 FROM pg_database WHERE datname='${POSTGRESQL_DATABASE}'" )" = 1 ]
	then
	    echo "Database already exists"
	else
	    echo "Database does not exist"
	    create_database    
	    set_connection_string
	  	create_rw_database_role
	  	create_ro_database_role
	fi
	wait_for_postgresql_master
	$PSQL -c "SELECT 1;"

fi

pg_ctl stop
unset_env_vars
exec postgres "$@"
